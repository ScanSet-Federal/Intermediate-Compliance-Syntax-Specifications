DEF
VAR var_101 string ``
VAR var_2 string `2016|2017|2019|2022`
VAR var_1 string `sqlserver`
CRI AND
CTN sqlext
    TEST `any exist` all
    STATE ste_101
        result string equals `
    `
    STATE_END
    OBJECT obj_101
        engine VAR var_1
        version VAR var_2
        instance `.*`
        database `.*`
        sql `SELECT
    R.name AS role_name,
    RM.name AS role_member_name,
    RM.type_desc
FROM sys.database_principals R
JOIN sys.database_role_members DRM ON 
    R.principal_id = DRM.role_principal_id
JOIN sys.database_principals RM ON 
    DRM.member_principal_id = RM.principal_id
WHERE R.type = 'R'
    AND R.name = 'db_owner'
ORDER BY 
    role_member_name`
        behavior context database
    OBJECT_END
CTN_END
CTN sqlext
    TEST `any exist` all
    STATE ste_102
        result string equals `
    `
    STATE_END
    OBJECT obj_102
        engine VAR var_1
        version VAR var_2
        instance `.*`
        database `.*`
        sql `SELECT
	PERM.permission_name,
	DP.name AS user_name,
	DP.type_desc AS principal_type,
	DBRM.role_member_name
FROM sys.database_permissions PERM
JOIN sys.database_principals DP ON PERM.grantee_principal_id = DP.principal_id
LEFT OUTER JOIN (
	SELECT
		R.principal_id AS role_principal_id,
		R.name AS role_name,
		RM.name AS role_member_name
	FROM sys.database_principals R
	JOIN sys.database_role_members DRM ON R.principal_id = DRM.role_principal_id
	JOIN sys.database_principals RM ON DRM.member_principal_id = RM.principal_id
	WHERE R.type = 'R'
) DBRM ON DP.principal_id = DBRM.role_principal_id
WHERE PERM.permission_name IN ('CONTROL','ALTER ANY DATABASE AUDIT')
ORDER BY
	permission_name, 
	user_name, 
	role_member_name`
        behavior context database
    OBJECT_END
CTN_END
CRI_END
DEF_END