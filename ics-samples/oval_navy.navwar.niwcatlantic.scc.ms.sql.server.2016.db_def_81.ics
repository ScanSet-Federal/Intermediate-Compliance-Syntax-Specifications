DEF
VAR var_2 string `2016|2017|2019|2022`
VAR var_83 string ``
VAR var_1 string `sqlserver`
CRI OR
CTN sqlext
    TEST `any exist` all
    STATE ste_81
        result string equals `
    `
    STATE_END
    OBJECT obj_81
        engine VAR var_1
        version VAR var_2
        instance `.*`
        database `^(?!msdb$|MSDB$).*`
        sql `SELECT SUSER_SNAME(d.owner_sid) AS database_owner,
CASE
WHEN d.is_trustworthy_on = 0 THEN 'No'
WHEN d.is_trustworthy_on = 1 THEN 'Yes'
END AS is_trustworthy,
CASE
WHEN role.name IN ('sysadmin','securityadmin')
OR permission.permission_name = 'CONTROL SERVER'
THEN 'YES'
ELSE 'No'
END AS 'is_owner_privileged'
FROM sys.databases d
LEFT JOIN sys.server_principals login ON d.owner_sid = login.sid
LEFT JOIN sys.server_role_members rm ON login.principal_id = rm.member_principal_id
LEFT JOIN sys.server_principals role ON rm.role_principal_id = role.principal_id
LEFT JOIN sys.server_permissions permission ON login.principal_id = permission.grantee_principal_id
WHERE d.name = DB_NAME()`
        behavior context database
    OBJECT_END
CTN_END
CTN sqlext
    TEST `any exist` all
    STATE ste_82
        result string equals `
    `
    STATE_END
    OBJECT obj_81
        engine VAR var_1
        version VAR var_2
        instance `.*`
        database `^(?!msdb$|MSDB$).*`
        sql `SELECT SUSER_SNAME(d.owner_sid) AS database_owner,
CASE
WHEN d.is_trustworthy_on = 0 THEN 'No'
WHEN d.is_trustworthy_on = 1 THEN 'Yes'
END AS is_trustworthy,
CASE
WHEN role.name IN ('sysadmin','securityadmin')
OR permission.permission_name = 'CONTROL SERVER'
THEN 'YES'
ELSE 'No'
END AS 'is_owner_privileged'
FROM sys.databases d
LEFT JOIN sys.server_principals login ON d.owner_sid = login.sid
LEFT JOIN sys.server_role_members rm ON login.principal_id = rm.member_principal_id
LEFT JOIN sys.server_principals role ON rm.role_principal_id = role.principal_id
LEFT JOIN sys.server_permissions permission ON login.principal_id = permission.grantee_principal_id
WHERE d.name = DB_NAME()`
        behavior context database
    OBJECT_END
CTN_END
CTN sqlext
    TEST `any exist` all
    STATE ste_83
        result string equals `
    `
    STATE_END
    OBJECT obj_81
        engine VAR var_1
        version VAR var_2
        instance `.*`
        database `^(?!msdb$|MSDB$).*`
        sql `SELECT SUSER_SNAME(d.owner_sid) AS database_owner,
CASE
WHEN d.is_trustworthy_on = 0 THEN 'No'
WHEN d.is_trustworthy_on = 1 THEN 'Yes'
END AS is_trustworthy,
CASE
WHEN role.name IN ('sysadmin','securityadmin')
OR permission.permission_name = 'CONTROL SERVER'
THEN 'YES'
ELSE 'No'
END AS 'is_owner_privileged'
FROM sys.databases d
LEFT JOIN sys.server_principals login ON d.owner_sid = login.sid
LEFT JOIN sys.server_role_members rm ON login.principal_id = rm.member_principal_id
LEFT JOIN sys.server_principals role ON rm.role_principal_id = role.principal_id
LEFT JOIN sys.server_permissions permission ON login.principal_id = permission.grantee_principal_id
WHERE d.name = DB_NAME()`
        behavior context database
    OBJECT_END
CTN_END
CRI_END
DEF_END