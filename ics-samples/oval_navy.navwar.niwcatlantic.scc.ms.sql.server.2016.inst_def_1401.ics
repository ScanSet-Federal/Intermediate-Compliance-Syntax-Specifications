DEF
VAR var_1403 string ``
VAR var_1404 string ``
VAR var_1 string `sqlserver`
VAR var_2 string `2016|2017|2019|2022`
RUN var_1403 CONCAT
    literal `SOFTWARE\Microsoft\Microsoft SQL Server\`
    OBJ obj_640 result
    literal `\MSSQLServer`
RUN_END
RUN var_1404 CONCAT
    OBJ obj_644 result
    literal `\SOFTWARE\Microsoft\Microsoft SQL Server\`
    OBJ obj_640 result
    literal `\MSSQLServer`
RUN_END
STATE ste_1403
    type string equals `reg_dword`
    value int equals `3`
STATE_END
CRI AND
CTN sqlext
    TEST `any exist` `at least one`
    STATE ste_1101
        result string equals `
    `
    STATE_END
    OBJECT obj_1101
        engine VAR var_1
        version VAR var_2
        instance `.*`
        database ``
        sql `SELECT name AS 'audit_name',
				status_desc AS 'audit_status',
				audit_file_path AS 'current_audit_file'
				FROM sys.dm_server_audit_status`
        behavior context instance
    OBJECT_END
CTN_END
CRI OR
CRI AND
CTN sqlext
    TEST `any exist` all
    OBJECT obj_1401
        engine VAR var_1
        version VAR var_2
        instance `.*`
        database ``
        sql `SELECT a.name AS 'AuditName', 
  s.name AS 'SpecName', 
 d.audit_action_name AS 'ActionName', 
  d.audited_result AS 'Result' 
FROM sys.server_audit_specifications s 
JOIN sys.server_audits a ON s.audit_guid = a.audit_guid 
JOIN sys.server_audit_specification_details d ON s.server_specification_id = d.server_specification_id 
WHERE a.is_state_enabled = 1 AND d.audit_action_name IN ('SUCCESSFUL_LOGIN_GROUP')
						`
        behavior context instance
    OBJECT_END
CTN_END
CTN sqlext
    TEST `any exist` all
    OBJECT obj_1402
        engine VAR var_1
        version VAR var_2
        instance `.*`
        database ``
        sql `SELECT a.name AS 'AuditName', 
  s.name AS 'SpecName', 
 d.audit_action_name AS 'ActionName', 
  d.audited_result AS 'Result' 
FROM sys.server_audit_specifications s 
JOIN sys.server_audits a ON s.audit_guid = a.audit_guid 
JOIN sys.server_audit_specification_details d ON s.server_specification_id = d.server_specification_id 
WHERE a.is_state_enabled = 1 AND d.audit_action_name IN ('FAILED_LOGIN_GROUP')
				`
        behavior context instance
    OBJECT_END
CTN_END
CRI_END
CRI OR
CTN registry
    TEST `any exist` all
    STATE_REF ste_1403
    OBJECT obj_1403
        hive `HKEY_LOCAL_MACHINE`
        key VAR var_1403
        name `AuditLevel`
    OBJECT_END
CTN_END
CTN registry
    TEST `any exist` all
    STATE_REF ste_1403
    OBJECT obj_1404
        hive `HKEY_LOCAL_MACHINE`
        key VAR var_1404
        name `AuditLevel`
    OBJECT_END
CTN_END
CRI_END
CRI_END
CTN sqlext
    TEST `any exist` all
    OBJECT obj_644
        engine VAR var_1
        version VAR var_2
        instance `.*`
        database ``
        sql `SELECT NodeName as 'node_name', status, status_description, is_current_owner   
FROM sys.dm_os_cluster_nodes;`
        behavior context instance
    OBJECT_END
CTN_END
CTN sqlext
    TEST `any exist` all
    OBJECT obj_640
        engine VAR var_1
        version VAR var_2
        instance `.*`
        database ``
        sql `EXECUTE xp_regread @rootkey='HKEY_LOCAL_MACHINE',
                   @key='SOFTWARE\Microsoft\Microsoft SQL Server\Instance Names\SQl',
                   @value_name=@@servicename`
        behavior context instance
    OBJECT_END
CTN_END
CRI_END
DEF_END